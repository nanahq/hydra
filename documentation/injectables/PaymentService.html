<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>EatLater Docs</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top d-block d-sm-none">
            <a href="../" class="navbar-brand">EatLater Docs</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >PaymentService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>apps/payment-service/src/charge/charge.service.ts</code>
        </p>





            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#logger" >logger</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#chargeWithBankTransfer" >chargeWithBankTransfer</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#chargeWithUssd" >chargeWithUssd</a>
                            </li>
                            <li>
                                    <span class="modifier"></span>
                                    <span class="modifier">Async</span>
                                <a href="#deleteUnpaidPayments" >deleteUnpaidPayments</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getAllPaymentInfo" >getAllPaymentInfo</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getPaymentInfo" >getPaymentInfo</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#initiateChargePaystack" >initiateChargePaystack</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#verifyPayment" >verifyPayment</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#verifyPaymentPaystack" >verifyPaymentPaystack</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(paymentRepository: <a href="../injectables/PaymentRepository.html" target="_self">PaymentRepository</a>, ordersClient: ClientProxy, listingClient: ClientProxy, notificationClient: ClientProxy, odsaClient: ClientProxy, flutterwave: <a href="../injectables/FlutterwaveService.html" target="_self">FlutterwaveService</a>, paystack: <a href="../injectables/PaystackService.html" target="_self">PaystackService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="29" class="link-to-prism">apps/payment-service/src/charge/charge.service.ts:29</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>paymentRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/PaymentRepository.html" target="_self" >PaymentRepository</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>ordersClient</td>
                                                  
                                                        <td>
                                                                    <code>ClientProxy</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>listingClient</td>
                                                  
                                                        <td>
                                                                    <code>ClientProxy</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>notificationClient</td>
                                                  
                                                        <td>
                                                                    <code>ClientProxy</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>odsaClient</td>
                                                  
                                                        <td>
                                                                    <code>ClientProxy</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>flutterwave</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/FlutterwaveService.html" target="_self" >FlutterwaveService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>paystack</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/PaystackService.html" target="_self" >PaystackService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="chargeWithBankTransfer"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>chargeWithBankTransfer</b></span>
                        <a href="#chargeWithBankTransfer"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>chargeWithBankTransfer(payload: <a href="../interfaces/BankTransferRequest.html" target="_self">BankTransferRequest</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="117"
                            class="link-to-prism">apps/payment-service/src/charge/charge.service.ts:117</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>payload</td>
                                    <td>
                                                <code><a href="../interfaces/BankTransferRequest.html" target="_self" >BankTransferRequest</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;BankTransferAccountDetails&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="chargeWithUssd"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>chargeWithUssd</b></span>
                        <a href="#chargeWithUssd"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>chargeWithUssd(payload: <a href="../interfaces/UssdRequest.html" target="_self">UssdRequest</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="46"
                            class="link-to-prism">apps/payment-service/src/charge/charge.service.ts:46</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>payload</td>
                                    <td>
                                                <code><a href="../interfaces/UssdRequest.html" target="_self" >UssdRequest</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deleteUnpaidPayments"></a>
                    <span class="name">
                        <span class="modifier"></span>
                        <span class="modifier">Async</span>
                        <span ><b>deleteUnpaidPayments</b></span>
                        <a href="#deleteUnpaidPayments"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>deleteUnpaidPayments()</code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <b>Decorators : </b>
                    <br />
                    <code>@Cron(CronExpression.EVERY_10_MINUTES, {timeZone: &#x27;Africa/Lagos&#x27;})<br /></code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="358"
                            class="link-to-prism">apps/payment-service/src/charge/charge.service.ts:358</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getAllPaymentInfo"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getAllPaymentInfo</b></span>
                        <a href="#getAllPaymentInfo"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getAllPaymentInfo(payload: literal type)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="347"
                            class="link-to-prism">apps/payment-service/src/charge/charge.service.ts:347</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>payload</td>
                                    <td>
                                            <code>literal type</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;[] | null&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getPaymentInfo"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getPaymentInfo</b></span>
                        <a href="#getPaymentInfo"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getPaymentInfo(payload: literal type)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="339"
                            class="link-to-prism">apps/payment-service/src/charge/charge.service.ts:339</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>payload</td>
                                    <td>
                                            <code>literal type</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="../classes/Payment.html" target="_self" >Promise&lt;Payment | null&gt;</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="initiateChargePaystack"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>initiateChargePaystack</b></span>
                        <a href="#initiateChargePaystack"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>initiateChargePaystack(req: <a href="../interfaces/OrderInitiateCharge.html" target="_self">OrderInitiateCharge</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="186"
                            class="link-to-prism">apps/payment-service/src/charge/charge.service.ts:186</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>req</td>
                                    <td>
                                                <code><a href="../interfaces/OrderInitiateCharge.html" target="_self" >OrderInitiateCharge</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;PaystackChargeResponseData&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="verifyPayment"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>verifyPayment</b></span>
                        <a href="#verifyPayment"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>verifyPayment(txId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, refId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="222"
                            class="link-to-prism">apps/payment-service/src/charge/charge.service.ts:222</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>txId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>refId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="verifyPaymentPaystack"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>verifyPaymentPaystack</b></span>
                        <a href="#verifyPaymentPaystack"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>verifyPaymentPaystack(refId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="281"
                            class="link-to-prism">apps/payment-service/src/charge/charge.service.ts:281</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>refId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="logger"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>logger</b></span>
                        <a href="#logger"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>console</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="29" class="link-to-prism">apps/payment-service/src/charge/charge.service.ts:29</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { HttpStatus, Inject, Injectable } from &#x27;@nestjs/common&#x27;
import {
  BankTransferAccountDetails,
  BankTransferRequest,
  BaseChargeRequest,
  FitRpcException, nairaToKobo,
  OrderI, OrderInitiateCharge,
  OrderStatus,
  Payment,
  PaymentServiceI, PaystackCharge,
  PaystackChargeResponseData,
  QUEUE_MESSAGE,
  QUEUE_SERVICE,
  RandomGen,
  ServicePayload,
  UpdateOrderStatusPaidRequestDto,
  UssdCharge,
  UssdRequest,
  PaystackService
} from &#x27;@app/common&#x27;
import { ClientProxy, RpcException } from &#x27;@nestjs/microservices&#x27;
import { catchError, lastValueFrom } from &#x27;rxjs&#x27;
import { PaymentRepository } from &#x27;./charge.repository&#x27;
import { FlutterwaveService } from &#x27;../providers/flutterwave&#x27;
import { Cron, CronExpression } from &#x27;@nestjs/schedule&#x27;

@Injectable()
export class PaymentService implements PaymentServiceI {
  private readonly logger &#x3D; console

  constructor (
    private readonly paymentRepository: PaymentRepository,
    @Inject(QUEUE_SERVICE.ORDERS_SERVICE)
    private readonly ordersClient: ClientProxy,
    @Inject(QUEUE_SERVICE.LISTINGS_SERVICE)
    private readonly listingClient: ClientProxy,
    @Inject(QUEUE_SERVICE.NOTIFICATION_SERVICE)
    private readonly notificationClient: ClientProxy,
    @Inject(QUEUE_SERVICE.DRIVER_SERVICE)
    private readonly odsaClient: ClientProxy,
    private readonly flutterwave: FlutterwaveService,

    private readonly paystack: PaystackService
  ) {}

  async chargeWithUssd (payload: UssdRequest): Promise&lt;{ code: string }&gt; {
    try {
      // Fetch order information
      const orderQueryPayload: ServicePayload&lt;{ orderId: string }&gt; &#x3D; {
        userId: payload.userId,
        data: { orderId: payload.orderId }
      }
      const order &#x3D; await lastValueFrom&lt;OrderI&gt;(
        this.ordersClient
          .send(QUEUE_MESSAGE.GET_SINGLE_ORDER_BY_ID, orderQueryPayload)
          .pipe(
            catchError((error) &#x3D;&gt; {
              throw new RpcException(error)
            })
          )
      )

      const existingPayment &#x3D; await this.paymentRepository.findOne({ order: order._id })

      if (existingPayment !&#x3D;&#x3D; null) {
        return JSON.parse(existingPayment.paymentMeta)
      }

      this.logger.log(
        &#x60;[PIM] - Initiating a ussd charge for user_id: ${order.user._id} order_refId: ${order.refId}&#x60;
      )

      // Prepare charge payload
      const chargePayload: UssdCharge &#x3D; {
        tx_ref: &#x60;NANA-${RandomGen.genRandomNum()}&#x60;,
        amount: String(order.orderValuePayable),
        email: order.user.email,
        currency: &#x27;NGN&#x27;,
        account_bank: payload.account_bank,
        account_number: payload.account_number
      }

      // Initiate charge and process response
      const response &#x3D; await this.flutterwave.ussd(chargePayload)

      const code &#x3D; {
        code: response?.meta?.authorization?.note
      }
      if (response.status &#x3D;&#x3D;&#x3D; &#x27;success&#x27;) {
        await this.paymentRepository.create({
          refId: chargePayload.tx_ref,
          chargedAmount: chargePayload.amount,
          paymentId: response.data.id,
          type: &#x27;USSD&#x27;,
          user: order.user._id,
          order: order._id,
          status: &#x27;PENDING&#x27;,
          paymentMeta: JSON.stringify(code)
        })

        this.logger.log(
          &#x60;[PIM] - Bank USSD charge initiated  for user_id: ${order.user._id} order_refId: ${order.refId}&#x60;
        )

        return code
      }
      throw new Error(&#x27;Failed&#x27;)
    } catch (e) {
      this.logger.error(&#x27;[PIM] Failed to create ussd charge -&#x27;, e)
      throw new FitRpcException(
        &#x27;Can not place charge at this moment. Try again later&#x27;,
        HttpStatus.INTERNAL_SERVER_ERROR
      )
    }
  }

  async chargeWithBankTransfer (
    payload: BankTransferRequest
  ): Promise&lt;BankTransferAccountDetails&gt; {
    try {
      // Fetch order information
      const orderQueryPayload: ServicePayload&lt;{ orderId: string }&gt; &#x3D; {
        userId: payload.userId,
        data: { orderId: payload.orderId }
      }
      const order &#x3D; await lastValueFrom&lt;OrderI&gt;(
        this.ordersClient
          .send(QUEUE_MESSAGE.GET_SINGLE_ORDER_BY_ID, orderQueryPayload)
          .pipe(
            catchError((error) &#x3D;&gt; {
              throw new RpcException(error)
            })
          )
      )

      const existingPayment &#x3D; await this.paymentRepository.findOne({ order: order._id })

      if (existingPayment !&#x3D;&#x3D; null) {
        return JSON.parse(existingPayment.paymentMeta)
      }

      this.logger.log(
        &#x60;[PIM] - Initiating a bank transfer charge for user_id: ${order.user._id} order_refId: ${order.refId}&#x60;
      )

      // Prepare charge payload
      const chargePayload: BaseChargeRequest &#x3D; {
        tx_ref: &#x60;NANA-${RandomGen.genRandomNum()}&#x60;,
        amount: String(order.orderValuePayable),
        email: order.user.email,
        currency: &#x27;NGN&#x27;
      }

      // Initiate charge and process response
      const response &#x3D; await this.flutterwave.bankTransfer(chargePayload)

      const paymentMeta &#x3D; bankChargeMapper(response.meta.authorization)
      if (response.status &#x3D;&#x3D;&#x3D; &#x27;success&#x27;) {
        await this.paymentRepository.create({
          refId: chargePayload.tx_ref,
          chargedAmount: chargePayload.amount,
          paymentId: response?.data?.id,
          type: &#x27;BANK_TRANSFER&#x27;,
          user: order.user._id,
          order: order._id,
          status: &#x27;PENDING&#x27;,
          paymentMeta: JSON.stringify(paymentMeta)
        })

        this.logger.log(
          &#x60;[PIM] - Bank transfer charge initiated  for user_id: ${order.user._id} order_refId: ${order.refId}&#x60;
        )

        return paymentMeta
      }
      throw new Error(&#x27;Failed&#x27;)
    } catch (e) {
      this.logger.log(&#x27;[PIM] Failed to create bank transfer charged -&#x27;, e)
      throw new FitRpcException(
        &#x27;Can not place charge at this moment. Try again later&#x27;,
        HttpStatus.INTERNAL_SERVER_ERROR
      )
    }
  }

  async initiateChargePaystack (req: OrderInitiateCharge): Promise&lt;PaystackChargeResponseData&gt; {
    this.logger.log(&#x60;[PIM] - Initiating paystack charge for order ${req.orderId}&#x60;)

    const payload: PaystackCharge &#x3D; {
      email: req.email,
      amount: nairaToKobo(req.amount),
      metadata: {
        transaction_ref: &#x60;NANA-${RandomGen.genRandomNum()}&#x60;
      }
    }

    this.logger.log(&#x27;service payload&#x27;, payload)
    try {
      const chargeMeta &#x3D; await this.paystack.initiateCharge(payload)

      await this.paymentRepository.create({
        refId: chargeMeta.data.reference,
        chargedAmount: req.amount,
        paymentId: chargeMeta.data.access_code,
        type: &#x27;PAYSTACK&#x27;,
        user: req.userId,
        order: req.orderId,
        status: &#x27;PENDING&#x27;,
        paymentMeta: JSON.stringify(chargeMeta.data)
      })
      return chargeMeta.data
    } catch (error) {
      this.logger.error(&#x60;Failed to initiate charge for order ${req.orderId}&#x60;)
      this.logger.error(error)
      throw new FitRpcException(
        &#x27;Can not place charge at this moment. Try again later&#x27;,
        HttpStatus.INTERNAL_SERVER_ERROR
      )
    }
  }

  async verifyPayment (txId: string, refId: string): Promise&lt;void&gt; {
    this.logger.log(
      &#x60;[PIM] - Verifying order payment ref: ${refId} txId: ${txId}&#x60;
    )
    try {
      const payment &#x3D; (await this.paymentRepository.findOne({
        refId
      })) as Payment

      if (payment.status !&#x3D;&#x3D; &#x27;PENDING&#x27;) {
        return
      }

      const checkIfPaymentIsCollected &#x3D; await this.flutterwave.verify(
        String(txId)
      )

      if (
        checkIfPaymentIsCollected?.data?.status !&#x3D;&#x3D; &#x27;successful&#x27; ||
        Number(checkIfPaymentIsCollected?.data?.charged_amount) !&#x3D;&#x3D;
          Number(payment.chargedAmount)
      ) {
        throw new Error(&#x27;Payment not successful&#x27;)
      }

      // Update order status
      const payload: ServicePayload&lt;UpdateOrderStatusPaidRequestDto&gt; &#x3D; {
        userId: &#x27;&#x27;,
        data: {
          status: OrderStatus.PROCESSED,
          orderId: payment.order,
          txRefId: payment.refId
        }
      }

      this.logger.log(
        &#x60;[PIM] - Updating order status after payment order_id: ${payment.order}&#x60;
      )

      await lastValueFrom&lt;any&gt;(
        this.ordersClient
          .emit(QUEUE_MESSAGE.UPDATE_ORDER_STATUS_PAID, payload)
          .pipe(
            catchError((error) &#x3D;&gt; {
              throw new RpcException(error)
            })
          )
      )

      await this.paymentRepository.update({ refId }, { status: &#x27;SUCCESS&#x27; })
    } catch (error) {
      this.logger.error(&#x27;[PIM] - Failed pending payment verification&#x27;, error)
      throw new FitRpcException(
        &#x27;Can not verify transaction. Try again later&#x27;,
        HttpStatus.INTERNAL_SERVER_ERROR
      )
    }
  }

  async verifyPaymentPaystack (refId: string): Promise&lt;void&gt; {
    this.logger.log(
      &#x60;[PIM] - Verifying paystack order payment ref: ${refId}&#x60;
    )

    try {
      const payment &#x3D; (await this.paymentRepository.findOne({
        refId
      })) as Payment

      if (payment.status !&#x3D;&#x3D; &#x27;PENDING&#x27;) {
        return
      }

      this.logger.log(&#x27;[PIM] - fetching payment verification&#x27;)

      const verificationStatus &#x3D; await this.paystack.verify(refId)

      this.logger.log(&#x60;[PIM] - fetched payment verification :${verificationStatus.data.status}&#x60;)

      if (verificationStatus.data.status.toLowerCase() !&#x3D;&#x3D; &#x27;success&#x27; || (verificationStatus.data.amount / 100) !&#x3D;&#x3D; Number(payment.chargedAmount)) {
        throw new Error(&#x27;Payment not successful&#x27;)
      }

      // Update order status
      const payload: ServicePayload&lt;UpdateOrderStatusPaidRequestDto&gt; &#x3D; {
        userId: &#x27;&#x27;,
        data: {
          status: OrderStatus.PROCESSED,
          orderId: payment.order,
          txRefId: payment.refId
        }
      }

      this.logger.log(
        &#x60;[PIM] - Updating order status after payment order_id: ${payment.order}&#x60;
      )

      await lastValueFrom&lt;any&gt;(
        this.ordersClient
          .emit(QUEUE_MESSAGE.UPDATE_ORDER_STATUS_PAID, payload)
          .pipe(
            catchError((error) &#x3D;&gt; {
              throw new RpcException(error)
            })
          )
      )

      await this.paymentRepository.update({ refId }, { status: &#x27;SUCCESS&#x27; })
    } catch (error) {
      this.logger.error(&#x27;[PIM] - Failed pending payment verification&#x27;, error)
      throw new FitRpcException(
        &#x27;Can not verify transaction at this moment. Try again later&#x27;,
        HttpStatus.INTERNAL_SERVER_ERROR
      )
    }
  }

  async getPaymentInfo (payload: { userId: string, orderId: string }): Promise&lt;Payment | null&gt; {
    try {
      return await this.paymentRepository.findOne({ order: payload.orderId, user: payload.userId })
    } catch (error) {
      throw new FitRpcException(&#x27;Something went wrong getting payment info&#x27;, HttpStatus.INTERNAL_SERVER_ERROR)
    }
  }

  async getAllPaymentInfo (payload: { userId: string }): Promise&lt;Payment[] | null&gt; {
    try {
      return await this.paymentRepository.find({ user: payload.userId })
    } catch (error) {
      throw new FitRpcException(&#x27;Something went wrong getting payment info&#x27;, HttpStatus.INTERNAL_SERVER_ERROR)
    }
  }

  @Cron(CronExpression.EVERY_10_MINUTES, {
    timeZone: &#x27;Africa/Lagos&#x27;
  })
  async deleteUnpaidPayments (): Promise&lt;void&gt; {
    try {
      const date &#x3D; new Date()
      const pastTenMinutes &#x3D; new Date(date.getTime() - 10 * 60 * 1000)

      const payments &#x3D; await this.paymentRepository.find({
        createdAt: {
          $lt: pastTenMinutes.toISOString()
        },
        status: &#x27;PENDING&#x27;
      }) as Payment[] | null

      if (payments !&#x3D;&#x3D; null &amp;&amp; payments.length &gt; 0) {
        const paymentIds &#x3D; payments.map(({ _id }) &#x3D;&gt; _id)

        await this.paymentRepository.deleteMany({
          _id: {
            $in: paymentIds
          }
        })

        this.logger.log(&#x60;[PIM] - Deleted ${payments.length} unpaid payments.&#x60;)
      }
    } catch (error) {
      this.logger.error(&#x27;[PIM] - Failed to delete unpaid payments:&#x27;, error)
      throw new FitRpcException(
        &#x27;Failed to delete unpaid payments. Please try again later.&#x27;,
        HttpStatus.INTERNAL_SERVER_ERROR
      )
    }
  }
}

function bankChargeMapper (authorization: any): BankTransferAccountDetails {
  return {
    transfer_amount: authorization.transfer_amount,
    transfer_bank: authorization.transfer_bank,
    account_expiration: authorization.account_expiration,
    transfer_reference: authorization.transfer_reference,
    transfer_account: authorization.transfer_account
  }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'PaymentService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
